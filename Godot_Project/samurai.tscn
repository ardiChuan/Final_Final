[gd_scene load_steps=4 format=3 uid="uid://d30ebo7uakvax"]

[sub_resource type="GDScript" id="GDScript_xvud8"]
script/source = "extends CharacterBody2D

# --- Movement Stat ---
const SPEED := 350.0
const ACCEL := 1200.0
const DECEL := 1800.0

# --- Attack System ---
enum AttackType {NONE, LIGHT, HEAVY}
var current_attack 						:= AttackType.NONE
var combo_count 						:= 0 
var max_combo 							:= 3
var buffered_input						:= AttackType.NONE
var is_attacking						:= false


# --- Light Attack Stat ---
var light_attack_duration				:= 0.2
var light_attack_damage 				:= 10
var light_combo_window 					:= 0.3

# --- Heavy Attack Stat ---
var heavy_attack_duration 				:= 0.5
var heavy_attack_damage 				:= 25
var heavy_charge_time 					:= 0.3

# --- Timer ---
var attack_timer 						:= 0.0
var combo_timer 						:= 0.0

@onready var visual			: ColorRect = $ColorRect
@onready var camera 		: Camera2D	= $Camera2D
@onready var hitbox			: Area2D 	= $Area2D

func _physics_process(delta):
	if not is_attacking:
		var input_dir := get_input_directon()
		update_velocity(input_dir,delta)
	else :
		update_velocity(Vector2.ZERO,delta)
	move_and_slide()
	handle_attack_input()
	update_attack(delta)

func get_input_directon() -> Vector2: 	
	var direction := Input.get_vector(\"move_left\",\"move_right\",\"move_up\",\"move_down\")
	return direction.normalized() if direction.length() > 1 else direction

func update_velocity(direction:Vector2, delta : float) -> void: 
	if direction != Vector2.ZERO:
		var target_velocity = direction * SPEED
		velocity = velocity.move_toward(target_velocity, ACCEL * delta)
	else:
		velocity = velocity.move_toward(Vector2.ZERO, DECEL * delta)

func handle_attack_input() -> void :
	if Input.is_action_just_pressed('attack'):
		if is_attacking :
			buffered_input = AttackType.LIGHT
		else :
			start_light_attack()
	if Input.is_action_just_pressed('heavy_attack'):
		if is_attacking :
			buffered_input = AttackType.HEAVY
		else :
			start_heavy_attack()
			
func start_light_attack() -> void :
	is_attacking = true
	current_attack = AttackType.LIGHT
	combo_count += 1
	if combo_count	> max_combo :
		combo_count = 1
	attack_timer = light_attack_duration
	combo_timer = light_combo_window
	hitbox.monitoring = true 
	
func start_heavy_attack() -> void :
	is_attacking = true
	current_attack = AttackType.HEAVY
	combo_count = 0 
	combo_timer = 0.0
	attack_timer = heavy_attack_duration
	hitbox.monitoring = true 

func update_attack(delta: float) -> void :
	if attack_timer > 0 :
		attack_timer -= delta
		if attack_timer <= 0 :
			end_attack()
			
	if combo_timer > 0 and not is_attacking:
		combo_timer -= delta
		if combo_timer <= 0 :
			combo_count = 0 
			

func end_attack() -> void:
	is_attacking = false
	current_attack = AttackType.NONE
	hitbox.monitoring = false
	
	if buffered_input != AttackType.NONE:
		var buffered = buffered_input
		buffered_input = AttackType.NONE
		
		if buffered == AttackType.LIGHT:
			start_light_attack()
		elif buffered == AttackType.HEAVY:
			start_heavy_attack()

func _on_hitbox_body_entered(body: Node2D) -> void:
	if body.has_method(\"take_damage\"):
		var damage = light_attack_damage if current_attack == AttackType.LIGHT else heavy_attack_damage
		body.take_damage(damage)
		
		if current_attack == AttackType.HEAVY :
			apply_hitstop(0.1)
			shake_camera(8.0)
		else : 
			apply_hitstop(0.05)
			shake_camera(5.0)
		spawn_hit_particle(body.global_position)

func apply_hitstop(duration : float = 0.05) -> void:
	Engine.time_scale = 0.1
	await get_tree().create_timer(duration, true, false, true).timeout
	Engine.time_scale = 1.0

func shake_camera(intensity: float = 5.0) -> void:
	var original_offset = camera.offset
	camera.offset = Vector2(randf_range(-intensity, intensity), randf_range(-intensity, intensity))
	await get_tree().create_timer(0.1).timeout
	camera.offset = original_offset

func spawn_hit_particle(pos: Vector2) -> void:
	for i in range(5):
		var particle = ColorRect.new()
		particle.size = Vector2(4, 4)
		particle.color = Color.YELLOW
		get_tree().root.add_child(particle)
		particle.global_position = pos + Vector2(randf_range(-10, 10), randf_range(-10, 10))
		
		var tween = create_tween()
		tween.set_parallel(true)
		tween.tween_property(particle, \"position\", particle.position + Vector2(randf_range(-30, 30), randf_range(-30, 30)), 0.4)
		tween.tween_property(particle, \"modulate:a\", 0.0, 0.4)
		await tween.finished
		particle.queue_free()
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_xvud8"]
size = Vector2(40, 40)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_ghijl"]
size = Vector2(40, 10)

[node name="samurai" type="CharacterBody2D"]
collision_layer = 0
collision_mask = 2
script = SubResource("GDScript_xvud8")

[node name="ColorRect" type="ColorRect" parent="."]
offset_top = -40.0
offset_right = 40.0
color = Color(0, 0, 1, 1)

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(20, -20)
shape = SubResource("RectangleShape2D_xvud8")

[node name="Camera2D" type="Camera2D" parent="."]
position = Vector2(20, -20)
scale = Vector2(0.6149694, 1.2313538)

[node name="Area2D" type="Area2D" parent="."]
position = Vector2(20, -20)
scale = Vector2(1.5501727, 1.6172944)
collision_layer = 0
collision_mask = 2

[node name="WeaponRect" type="ColorRect" parent="Area2D"]
offset_left = -39.995544
offset_right = 0.0044555664
offset_bottom = 40.0
scale = Vector2(1, 0.25046137)
color = Color(0.9490128, 0.15442729, 0.41233844, 1)
metadata/_edit_use_anchors_ = true

[node name="CollisionShape2D2" type="CollisionShape2D" parent="Area2D"]
position = Vector2(-19.997774, 4.9465327)
shape = SubResource("RectangleShape2D_ghijl")

[connection signal="body_entered" from="Area2D" to="." method="_on_hitbox_body_entered"]
